<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/internshipsPublic.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <title>s'Cool Family</title>
</head>
<body>
<%- include('headerPublic') %>
<section>
    <div id="fullInternships">
        <% if (data.length == 0){ %>
        <p id="no_internship"> Il n'y a aucun stage prévu.</p>
        <% } else { %>
        <% data.forEach(function(elem, index) { %>
        <div class="internship">
            <div>
                <div id="title">
                    <h5><%= elem.name %></h5>
                </div>
                <% if (elem.image && elem.numberAvailable > 0) { %>
                <img class='img' src="data:image/png;base64,<%= elem.image.toString('base64') %>" alt="Illustration du stage">
                <% } else if (elem.numberAvailable == 0) { %>
                <img class='img' src="/full.png" alt="Stage complet">
                <% } else { %>
                <img class='img' src="/no_image.png" alt="Pas d'image disponible">
                <% } %>
                <ul>
                    <li><%= elem.desc %>
                        <% if (elem.desc) { %>
                        <% const maxLength = 100; %>
                        <%= elem.desc.length > maxLength ? elem.desc.slice(0, maxLength) + "..." : elem.desc %>
                        <% } %>
                    </li>
                    <li><strong>À partir de</strong> <%= elem.fromAge %> ans</li>
                    <li><strong>Où</strong> ?
                        <input type="button" style="color: #ff8800;" class="map" value="<%= elem.place %>">
                        <input type="hidden" class="map" value="<%= index %>, <%= elem.geo.lat %>, <%= elem.geo.lon %>">
                    </li>
                    <li><strong>Quand ? </strong> Du <%= new Date(elem.startDate).toLocaleDateString('fr-FR') %>
                        au <%= new Date(elem.endDate).toLocaleDateString('fr-FR') %>
                    </li>
                    <li><strong>Horaire:</strong> De <%= elem.startHour %> au <%= elem.endHour %> </li>
                    <li><%= elem.price %>€ / inscription</li>
                    <a href="/public/signIn?internshipId=<%= elem.id %>" class="btn btn-warning">S'inscrire</a>
                </ul>
            </div>
        </div>
        <% }); %>
    </div>
    <% } %>
</section>

<script>
    let allImg = document.querySelectorAll('.img');
    if (window.matchMedia("(min-width: 768px)").matches){
        allImg.forEach(i => {
            i.style.height = 265 + 'px';
        });
    }

    allImg.forEach(img => {
        img.addEventListener('click', () => {
            // Création de la modal
            let modal = document.createElement('div');
            modal.classList.add('modal');

            // Création de la croix de fermeture
            let closeBtn = document.createElement('span');
            closeBtn.classList.add('close');
            closeBtn.innerHTML = '&times;';
            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                document.body.classList.remove('blur');
            });

            // Création de l'image agrandie
            let modalImg = document.createElement('img');
            modalImg.classList.add('modal-content');
            modalImg.src = img.src;

            // Ajout de la croix de fermeture à la modal
            modal.appendChild(closeBtn);

            // Ajout de l'image agrandie à la modal
            modal.appendChild(modalImg);

            // Ajout de la modal au corps de la page
            document.body.appendChild(modal);

            // Floutage de l'arrière-plan
            document.body.classList.add('blur');

            // Affichage de la modal
            modal.style.display = 'block';
        });
    });

    // Ajout d'un écouteur d'événement au corps de la page pour fermer la modal lorsque l'on clique en dehors de l'image agrandie
    document.body.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
            document.body.classList.remove('blur');
        }
    });

    let allMaps = document.querySelectorAll('.map');
    allMaps.forEach(elem => {

        elem.addEventListener('click', function() {
            let nextDivHidden = elem.nextElementSibling;
            let isDivAlreadyExist = document.getElementById(elem.value + nextDivHidden.value);

            if (!isDivAlreadyExist && nextDivHidden.value !== undefined) {

                const [index, lat, lon] = nextDivHidden.value.toString().split(', ');
                let mapDiv = document.createElement('div');
                mapDiv.style.height = '20vh';
                mapDiv.setAttribute('id', elem.value + index);
                elem.insertAdjacentElement('afterend', mapDiv);
                let myLatLng = [lat, lon];
                let map = L.map(mapDiv).setView(myLatLng, 10);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                L.marker(myLatLng).addTo(map)
                    .bindPopup('Hello World!');
            }

            let parentDiv = elem.closest('.internship');
            let contentHeight = parentDiv.scrollHeight;
            parentDiv.style.height = contentHeight + 'px';
        });
    });

</script>
<%- include('footerPublic') %>
</body>
</html>